name: Artifact Release

on:
  push:
  workflow_dispatch:
    inputs:
      release:
        description: "Release (e.g., v0.22.0)"
        required: true

permissions: read-all

jobs:
  info:
    runs-on: ubuntu-latest
    env:
      RELEASE: ${{ github.event.inputs.release }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Download Artifact
        run: |
          set -x -e
          COMMIT=28a16b480e58979ce11f8252092d5a34834ece9b #$(git rev-list -n 1 ${RELEASE})
          WORKFLOW=$(curl -s \
            -H 'Accept: application/vnd.github.v3+json' \
            -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            https://api.github.com/repos/tensorflow/io/actions/workflows \
              | jq -r '.workflows | map(select(.name=="GitHub CI"))[0].id')
          RUN=$(curl -s \
            -H 'Accept: application/vnd.github.v3+json' \
            -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            https://api.github.com/repos/tensorflow/io/actions/workflows/${WORKFLOW}/runs \
              | jq -r ".workflow_runs | map(select(.head_sha==\"${COMMIT}\"))[0].id")
          ARCHIVE=$(curl -s \
            -H 'Accept: application/vnd.github.v3+json' \
            -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            https://api.github.com/repos/tensorflow/io/actions/runs/${RUN}/artifacts \
              | jq -r '.artifacts | map(select(.name=="tensorflow-io-release"))[0].archive_download_url')
          echo "::set-output link=archive::${ARCHIVE}"
        id: artifact
    outputs:
      commit: ${{ steps.artifact.outputs.commit }}
      link: ${{ steps.artifact.outputs.link }}

  test:
    runs-on: ubuntu-latest
    needs:
      - info
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ steps.artifact.outputs.commit }}
      - name: Download Artifact
        run: |
          set -x -e
          curl ${{ needs.info.outputs.link }}
          curl -s -vv \
            -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            -o archive.zip \
            ${{ needs.artifact-link.outputs.link }}
          ls -la
          unzip archive.zip
          ls -la
